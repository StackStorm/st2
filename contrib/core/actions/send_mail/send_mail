#!/bin/bash

HOSTNAME=$(hostname -f)
LINE_BREAK=""

SENDMAIL=`which sendmail`
if [ $? -ne 0 ]; then
    echo "Unable to find sendmail binary in PATH" >&2
    exit 2
fi

MAIL="$SENDMAIL -t"
FOOTER="This message was generated by StackStorm action `basename $0` running on `hostname`"
if [[ $1 =~ '@' ]]; then
  FROM=$1
else
  FROM="$1@${HOSTNAME}"
fi
shift
TO=$1
shift
SUBJECT=$1
shift
SEND_EMPTY_BODY=$1
shift
CONTENT_TYPE=$1
shift
BODY="$@"

if [[ "${CONTENT_TYPE}" = "text/html" ]]; then
  LINE_BREAK="<br><br>"
else
  LINE_BREAK=""
fi

trimmed="${BODY// }"
if [[ -z $trimmed && $SEND_EMPTY_BODY == 'True' ]] || [[ -n $trimmed ]]; then
  ${MAIL} <<EOF
TO: ${TO}
FROM: ${FROM}
SUBJECT: ${SUBJECT}
Content-Type: ${CONTENT_TYPE}

${BODY}
${LINE_BREAK}
${FOOTER}

EOF

fi

if [ $? -ne 0 ]; then
  echo "Failed to send mail to ${TO}"
  exit 2
else
  echo "Successfully sent mail to ${TO}"
  exit 0
fi
